<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>PhysXé›¶å€¼Crash | æ³¢æ³¢æ²™ğŸ </title><meta name=keywords content="Game Dev,PhysX"><meta name=description content="æœ¬æ–‡æ˜¯PhysXç‰©ç†å¼•æ“ç³»åˆ—çš„ç‰¹åˆ«ç¯‡ï¼Œè®°å½•äº†å½±å“è¿‘ä¸€å‘¨çš„ç‰©ç†å¼•æ“åº•å±‚æ¦‚ç‡æ€§Crashçš„å®šä½è¿‡ç¨‹å’Œä¿®å¤æ–¹æ³•ï¼Œå…·æœ‰å¾ˆé«˜çš„å®è·µå‚è€ƒä»·å€¼ã€‚â€œæœ‰å¤šé«˜ï¼Ÿ"><meta name=author content><link rel=canonical href=https://pps43.github.io/posts/using_physx_solving_zero_value_crash/><link crossorigin=anonymous href=/assets/css/stylesheet.dc6c194da045b61516d4431bed7d37869927fdf64deae5a9483581931f34796a.css integrity="sha256-3GwZTaBFthUW1EMb7X03hpkn/fZN6uWpSDWBkx80eWo=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://pps43.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://pps43.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://pps43.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://pps43.github.io/apple-touch-icon.png><link rel=mask-icon href=https://pps43.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css integrity="sha512-0aPQyyeZrWj9sCA46UlmWgKOP0mUipLQ6OZXu8l4IcAmD2u31EPEy9VcIMvl7SoAaKe8bLXZhYoMaE/in+gcgA==" crossorigin=anonymous referrerpolicy=no-referrer><script src=https://unpkg.com/mermaid/dist/mermaid.min.js></script>
<script>const config={startOnLoad:!0,theme:"neutral",themeVariables:{lineColor:"#aaaaaa"},flowchart:{useMaxWidth:!1,htmlLabels:!0}};mermaid.initialize(config),window.onload=()=>{window.mermaid.init(void 0,document.querySelectorAll(".language-mermaid"))}</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id=MathJax-script async src=https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7GDH7EZ6GL"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-7GDH7EZ6GL",{anonymize_ip:!1})}</script><meta property="og:title" content="PhysXé›¶å€¼Crash"><meta property="og:description" content="æœ¬æ–‡æ˜¯PhysXç‰©ç†å¼•æ“ç³»åˆ—çš„ç‰¹åˆ«ç¯‡ï¼Œè®°å½•äº†å½±å“è¿‘ä¸€å‘¨çš„ç‰©ç†å¼•æ“åº•å±‚æ¦‚ç‡æ€§Crashçš„å®šä½è¿‡ç¨‹å’Œä¿®å¤æ–¹æ³•ï¼Œå…·æœ‰å¾ˆé«˜çš„å®è·µå‚è€ƒä»·å€¼ã€‚â€œæœ‰å¤šé«˜ï¼Ÿ"><meta property="og:type" content="article"><meta property="og:url" content="https://pps43.github.io/posts/using_physx_solving_zero_value_crash/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-06-13T00:00:00+00:00"><meta property="article:modified_time" content="2023-06-13T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="PhysXé›¶å€¼Crash"><meta name=twitter:description content="æœ¬æ–‡æ˜¯PhysXç‰©ç†å¼•æ“ç³»åˆ—çš„ç‰¹åˆ«ç¯‡ï¼Œè®°å½•äº†å½±å“è¿‘ä¸€å‘¨çš„ç‰©ç†å¼•æ“åº•å±‚æ¦‚ç‡æ€§Crashçš„å®šä½è¿‡ç¨‹å’Œä¿®å¤æ–¹æ³•ï¼Œå…·æœ‰å¾ˆé«˜çš„å®è·µå‚è€ƒä»·å€¼ã€‚â€œæœ‰å¤šé«˜ï¼Ÿ"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://pps43.github.io/posts/"},{"@type":"ListItem","position":3,"name":"PhysXé›¶å€¼Crash","item":"https://pps43.github.io/posts/using_physx_solving_zero_value_crash/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"PhysXé›¶å€¼Crash","name":"PhysXé›¶å€¼Crash","description":"æœ¬æ–‡æ˜¯PhysXç‰©ç†å¼•æ“ç³»åˆ—çš„ç‰¹åˆ«ç¯‡ï¼Œè®°å½•äº†å½±å“è¿‘ä¸€å‘¨çš„ç‰©ç†å¼•æ“åº•å±‚æ¦‚ç‡æ€§Crashçš„å®šä½è¿‡ç¨‹å’Œä¿®å¤æ–¹æ³•ï¼Œå…·æœ‰å¾ˆé«˜çš„å®è·µå‚è€ƒä»·å€¼ã€‚â€œæœ‰å¤šé«˜ï¼Ÿ","keywords":["Game Dev","PhysX"],"articleBody":" æœ¬æ–‡æ˜¯PhysXç‰©ç†å¼•æ“ç³»åˆ—çš„ç‰¹åˆ«ç¯‡ï¼Œè®°å½•äº†å½±å“è¿‘ä¸€å‘¨çš„ç‰©ç†å¼•æ“åº•å±‚æ¦‚ç‡æ€§Crashçš„å®šä½è¿‡ç¨‹å’Œä¿®å¤æ–¹æ³•ï¼Œå…·æœ‰å¾ˆé«˜çš„å®è·µå‚è€ƒä»·å€¼ã€‚â€œæœ‰å¤šé«˜ï¼Ÿâ€â€œä¸‰å››å±‚æ¥¼é‚£ä¹ˆé«˜å•¦ï¼â€\nå‘ç°é—®é¢˜ è¿ç»´åŒäº‹å‘ç°ä½“éªŒæœå’ŒæŸåŒºåœ¨æ–°ç‰ˆæœ¬ä¸Šçº¿ä¸€å°æ®µæ—¶é—´åï¼Œä¼šå‡ºç°æ¦‚ç‡ä¸é«˜ä½†æŒç»­å‡ºç°çš„è¿›ç¨‹Crashã€‚è¿™é‡Œå…ˆç®€å•è¯´æ˜ä¸€ä¸‹ï¼šæˆ‘ä»¬ä¼šåœ¨ä¸€å°æœºå™¨ä¸Šéƒ¨ç½²å¤šä¸ªGameServerå®ä¾‹ï¼Œæ¯ä¸ªGameServerå®ä¾‹è¿›ç¨‹åŒæ—¶è¿›è¡Œç€å¤šåœºä¸åŒçš„Matchï¼Œå¦‚æœæŸä¸€åœºMatchå‡ºç°äº†ä¸šåŠ¡å±‚Crashï¼Œå¹¶ä¸ä¼šå½±å“å…¶ä»–Matchã€‚ä½†å¦‚æœæ˜¯C++ç‰©ç†åº“å†…å‡ºç°Crashï¼Œåˆ™ä¼šåŒæ—¶ä¸­æ­¢å…¶ä»–æ­£å¸¸è¿è¡Œçš„Matchï¼Œå¯¹ç©å®¶çš„å½±å“è¾ƒå¤§ã€‚\nè™½ç„¶çœ‹ä¸åˆ°å®Œæ•´çš„å †æ ˆï¼Œä½†ä»ä¸­è¿˜æ˜¯å‘ç°å’Œç‰©ç†å¼•æ“çš„SceneQueryæœ‰å…³ã€‚ å…¶å®è¿˜æœ‰å¦ä¸€ä¸ªå¾ˆç›¸ä¼¼çš„å †æ ˆï¼ˆå¿˜è®°ä¿å­˜æˆªå›¾äº†ï¼‰åœ¨prefilterä¸Šæ–¹è¿˜æœ‰ä¸€è¡ŒNpShape vtable...ã€‚ç”±äºprefilterå®ç°é€»è¾‘ä¸­ç¡®å®è°ƒç”¨äº†shape.getFlags()ï¼Œæ‰€ä»¥æ€€ç–‘æ˜¯è·Ÿshapeç›¸å…³é€»è¾‘ä¸­å‡ºç°ç©ºæŒ‡é’ˆå¼•ç”¨ã€‚ä½†ç”±äºshapeæ˜¯å¼•æ“å†…éƒ¨ç»´æŠ¤çš„ï¼Œæ‰€ä»¥ä¸Šè¿°æ€€ç–‘å¹¶ä¸èƒ½æä¾›æ˜ç¡®çš„ä¿®å¤æ–¹æ³•ã€‚\n// prefilter implementaion PxQueryHitType::Enum PhysxQueryFilterCallback::preFilter(const PxFilterData\u0026 filterData, const PxShape* shape, const PxRigidActor* actor, PxHitFlags\u0026 queryFlags) { bool isTrigger = shape-\u003egetFlags() \u0026 physx::PxShapeFlag::eTRIGGER_SHAPE; if (isTrigger \u0026\u0026 !m_IncludeTrigger) { return PxQueryHitType::eNONE; } PxFilterData shapefilterData = shape-\u003egetQueryFilterData(); if (shapefilterData.word0 \u0026 filterData.word0) { // m_HitType should be PxQueryHitType::eBLOCK or PxQueryHitType::eTOUCH return m_HitType; } return PxQueryHitType::eNONE; } // shape-\u003egetFlags() implementation (fron physx source code) PxShapeFlags NpShape::getFlags() const { NP_READ_CHECK(getOwnerScene()); return mShape.getFlags(); } ç”±äºåŒæœŸå‘å¸ƒçš„è¿˜æœ‰å…¶ä»–ç‰©ç†ç›¸å…³åŠŸèƒ½ï¼Œå…ˆé€šè¿‡å¼€å…³è¿™äº›åŠŸèƒ½æ¥å¯¹Crashåšåˆæ­¥åˆ¤å®šã€‚æœ‰ä¸€ä¸ªå»¶è¿Ÿåˆ é™¤Actorçš„ä¼˜åŒ–è¾ƒä¸ºå¯ç–‘ï¼Œå…³é—­è¯¥åŠŸèƒ½åï¼ŒCrashç¡®å®å‡å°‘äº†ä¸€å°éƒ¨åˆ†ã€‚\nå¦å¤–ä¹Ÿå°è¯•é€šè¿‡åˆ†ææ—¥å¿—å¯¹è¿™äº›Crashå‘ç”Ÿçš„æƒ…å¢ƒåšçŒœæµ‹ï¼Œä¾¿äºå¤ç°ã€‚å‰é¢æåˆ°è¿‡ï¼Œç‰©ç†å±‚ä¸€æ—¦Crashä¼šå½±å“åˆ°è¯¥è¿›ç¨‹ä¸‹å…¶ä»–æ­£å¸¸è¿›è¡Œçš„æ¯”èµ›ã€‚æ‰€ä»¥åªå¥½æŠ“å–äº†Crashå‘ç”Ÿå‰200msçš„æ‰€æœ‰ç›¸å…³æ¯”èµ›çš„æ—¥å¿—ï¼Œå¤§è‡´èƒ½çœ‹å‡ºæœ€åå‡ ç§’å†…ç©å®¶è¿›è¡Œäº†å“ªäº›æ“ä½œï¼šå•†åº—è´­ä¹°ã€åˆ‡æ¢æ­¦å™¨ã€ä¼¤å®³æ‰£è¡€ã€æ‰”æ‰‹é›·ã€‚è¿™é‡Œåªæœ‰æ‰”æ‰‹é›·å’Œç‰©ç†å±‚æœ‰å…³è”ï¼Œè¿›ä¸€æ­¥æ‰¾åˆ°è¯¥åœºæ¯”èµ›çš„æ¨¡å¼ä¿¡æ¯ï¼Œå‘Šè¯‰QAåŒå­¦å°è¯•å¤ç°ã€‚\nç¬¬ä¸€æ¬¡å°è¯•ä¿®å¤ æµ‹è¯•ç¯å¢ƒä¸­ä¸€ç›´æœªèƒ½å¤ç°ï¼Œæ‰€ä»¥å…ˆå°è¯•äº†ä¸€äº›é˜²å¾¡æ€§åˆ¤ç©ºä¿®å¤ã€‚æ¯”å¦‚åœ¨æ¯å¸§é©±åŠ¨ç‰©ç†æ›´æ–°æ—¶ï¼Œå¯¹Sceneçš„åˆ¤ç©ºï¼›åˆæ¯”å¦‚åœ¨OnContactæ—¶ï¼Œå¢åŠ äº†å¯¹actorå’Œshapeå¤±æ•ˆçŠ¶æ€çš„åˆ¤æ–­ï¼Œå¹¶ä¸”è·å–actorçš„æ–¹å¼ç”±pairs[i].shapes[0]-\u003egetActor()æ”¹ä¸ºpairHeader.actors[0]ã€‚è¿™äº›ä¿®å¤ç¡®å®èƒ½åŠ å¼ºç¨‹åºçš„å¥å£®æ€§ï¼Œä½†å¯æƒœå¯¹æœ¬æ¬¡çš„Crashå¹¶æ²¡æœ‰ç›´æ¥å¸®åŠ©ã€‚\nvoid PhysxSimulationEventCallback::onContact(const PxContactPairHeader\u0026 pairHeader, const PxContactPair* pairs, PxU32 nbPairs) { // add actor validation if (pairHeader.flags \u0026 PxContactPairHeaderFlag::eREMOVED_ACTOR_0 || pairHeader.flags \u0026 PxContactPairHeaderFlag::eREMOVED_ACTOR_1) { return; } PxRigidActor* actorA = (PxRigidActor*)pairHeader.actors[0]; PxRigidActor* actorB = (PxRigidActor*)pairHeader.actors[1]; for (PxU32 i = 0; i \u003c nbPairs; i++) { const PxContactPair\u0026 curPair = pairs[i]; // add shape validation if (curPair.flags \u0026 (PxContactPairFlag::eREMOVED_SHAPE_0 | PxContactPairFlag::eREMOVED_SHAPE_1)) { continue; } if (curPair.events \u0026 PxPairFlag::eNOTIFY_TOUCH_PERSISTS) { // do nothing when contact persists } else { PhysXContactResult result; result.Lost = curPair.events \u0026 PxPairFlag::eNOTIFY_TOUCH_LOST; result.ColliderA = actorA == NULL ? NULL : (PhysXActor*) actorA-\u003euserData; result.ColliderB = actorB == NULL ? NULL : (PhysXActor*) actorB-\u003euserData; if (result.ColliderA != NULL \u0026\u0026 result.ColliderB != NULL) { m_ContactRecords.push_back(result); } } } } ç¬¬äºŒæ¬¡å°è¯•ä¿®å¤ ä¸ºäº†è·å–æ›´å¤šä¿¡æ¯ï¼Œå†³å®šè´¹ä¸€äº›å‘¨ç« ï¼Œåœ¨ä¸€å°çº¿ä¸Šæœºå™¨éƒ¨ç½²Debugç‰ˆç‰©ç†åº“ã€‚äº‹å®è¯æ˜ï¼Œè¿™ä¸ªåŠªåŠ›æ˜¯å€¼å¾—çš„ã€ç«‹ç«¿è§å½±çš„ã€‚\nå¹³æ—¶æœåŠ¡å™¨ç¨‹åºæ‰“ReleaseåŒ…æ—¶ï¼Œé“¾æ¥åˆ°Releaseç‰ˆçš„ç‰©ç†åº“å·¥ç¨‹ï¼ˆåº•å±‚ä½¿ç”¨äº†physXï¼‰ï¼š\npackage physxgo /* #cgo CPPFLAGS: -Wno-attributes -I ./include -O3 -DNDEBUG #cgo LDFLAGS:-L ./lib -lPhysXWrapper_x64 -O3 */ import \"C ç°æ”¹ä¸ºé“¾æ¥åˆ°Debugç‰ˆç‰©ç†åº“å·¥ç¨‹ï¼š\npackage physxgo /* #cgo CPPFLAGS: -Wno-attributes -I ./include -O1 -DNDEBUG #cgo LDFLAGS:-L ./lib -lPhysXWrapperDEBUG_x64 -O1 */ import \"C\" åœ¨æœ¬åœ°Windowsä¸Šæµ‹è¯•é€šè¿‡åï¼Œéƒ¨ç½²åˆ°Linuxå´å¤±è´¥äº†ï¼šå‘ç°ä¾ç„¶é“¾æ¥åˆ°Releaseç‰©ç†åº“ã€‚\nè¿™é‡Œç¨åŠ è¯´æ˜ï¼šæœåŠ¡å™¨æ˜¯Linuxçš„ï¼Œä½†ä¸ºäº†å¹³æ—¶èƒ½åœ¨Windowsä¸Šå¼€å‘è°ƒè¯•ç‰©ç†åº“ï¼Œæˆ‘ä»¬æ­å»ºäº†ä¸¤å¥—æ„å»ºæµç¨‹ã€‚åœ¨Linuxä¸Šä½¿ç”¨makefileç¼–è¯‘å‡º.soï¼Œåœ¨Windowsä¸Šæ„å»ºå‡º.dllä¾›cgoè°ƒç”¨ã€‚æ³¨æ„cgoä½¿ç”¨gccï¼Œç”±äºname manglingæ–¹å¼å’ŒMSVCä¸åŒï¼Œåœ¨ä½¿ç”¨MSVCç¼–è¯‘æ—¶éœ€è¦åœ¨.defæ–‡ä»¶ä¸­æŒ‡å®šæ¯ä¸ªå¯¼å‡ºçš„å‡½æ•°ç¼–è¯‘åçš„åå­—ï¼Œå½¢å¦‚x=yï¼Œè¿™æ ·MSVCä¼šæŠŠè‡ªå·±ç¼–å‡ºçš„yç¿»è¯‘æˆxï¼Œä»¥ä¾¿å’Œgccå…¼å®¹ã€‚\nä¸¾ä¾‹ï¼š_ZN10PhysXActor11SetPositionEfff=?SetPosition@PhysXActor@@QEAAXMMM@Z\nåŸå› æ˜¯go buildæ˜¯å¼ºåˆ¶ä½¿ç”¨äº†é…ç½®çš„ç¯å¢ƒå˜é‡ä»¥åŠç¼“å­˜ã€‚ä½¿ç”¨go build -dæ¸…ç©ºç¼“å­˜å³å¯ã€‚\næˆåŠŸéƒ¨ç½²DebugåŒ…åˆ°ä¸€å°æœåŠ¡å™¨ä¸Šåï¼Œè¿‡15minå°±Crashäº†ï¼Œåœ¨æœ€åä¸€åˆ»ä¼ é€’å‡ºäº†æ–°çš„ä¿¡æ¯ï¼š\nåˆ›å»ºshapeæ—¶å‚æ•°ä¸åˆæ³•ï¼Œé¦–å…ˆæ€€ç–‘ä¼ å…¥äº†0æˆ–NaNã€‚è¿›ä¸€æ­¥çš„æ’æŸ¥å‘ç°ï¼Œè¿™ä¸ªç‰ˆæœ¬ä½¿ç”¨äº†æ–°ç‰ˆçš„åˆ›å»ºå‡½æ•°ï¼Œç¡®å®ç›¸æ¯”è€çš„åˆ›å»ºæµç¨‹å°‘äº†ä¸€ä¸ªå‚æ•°åˆæ³•æ€§æ ¡éªŒã€‚å½“å‘ç°æŸä¸ªç»´åº¦å‡ºç°0å€¼æ—¶ï¼Œè™½ç„¶ä¸ä¼šç«‹å³Crashï¼Œä½†åœ¨åç»­è¢«Raycastç­‰æ“ä½œè®¿é—®åˆ°æ—¶ï¼Œä¼šæ¦‚ç‡æ€§Crashã€‚è§£å†³æ–¹æ³•å¾ˆç®€å•ï¼Œåœ¨ä¸šåŠ¡å±‚å·²æœ‰ä»£ç ä¸­ï¼Œå‘ç°ä¼ å…¥0æ—¶ç»™å‡ºè­¦å‘Šå¹¶returnï¼›åœ¨åº•å±‚ä»£ç ä¸­åˆ›å»ºshapeæ—¶ï¼Œå¼ºåˆ¶å°†å€¼ä¸º0çš„ç»´åº¦æ”¹ä¸ºä¸€ä¸ªå¾®å°çš„å€¼ï¼Œå¦‚ä¸‹ForceNonZeroã€‚\nvoid ForceNonZero() { //EPS = 1.192092896e-07F (machine epsilon for float) if (physx::PxAbs(x) \u003c EPS) { x = x \u003e= 0 ? EPS : -EPS; } if (physx::PxAbs(y) \u003c EPS) { y = y \u003e= 0 ? EPS : -EPS; } if (physx::PxAbs(z) \u003c EPS) { z = z \u003e= 0 ? EPS : -EPS; } } éƒ¨ç½²è¯¥ä¿®å¤åï¼ŒCrashå½’é›¶ã€‚\nå¹¶ä¸”é€šè¿‡Debugç‰ˆç»™å‡ºçš„è­¦å‘Šï¼Œæˆ‘ä»¬è¿˜å¯¹æ•°å€¼ç±»å‚æ•°åšäº†NaNæˆ–Infæ ¡éªŒphysx::PxIsFiniteï¼Œå¹¶ä¸”å¯¹æ–¹å‘ç±»å‚æ•°åšäº†å¼ºåˆ¶å½’ä¸€åŒ–ï¼Œè¿›ä¸€æ­¥æé«˜äº†ç‰©ç†ç³»ç»Ÿç¨³å®šæ€§ã€‚å€¼æ­¤ï¼Œä¿®å¤å®Œæˆã€‚\næ€»ç»“ å¯¹äºä¼ å…¥physXçš„å‚æ•°å¿…é¡»ä¸¥æ ¼ä¿è¯æœ‰æ•ˆæ€§ã€‚\nåŸºæœ¬è¦æ±‚ï¼šæ•°å€¼ç±»ä¸å¯ä»¥æ˜¯NaN, Inf å°ºå¯¸ç±»ä¸å¯ä»¥æ˜¯0 æ–¹å‘ç±»çŸ¢é‡å¿…é¡»æ¨¡é•¿ä¸º1 å¹³æ—¶å¼€å‘ä¸­å¤šå…³æ³¨Debugç‰ˆçš„è¾“å‡ºï¼Œå¯¹äºè­¦å‘Šå’Œé”™è¯¯éƒ½è¦é«˜åº¦é‡è§†ã€‚\né—®é¢˜å‘ç”Ÿæ—¶ï¼Œå¦‚æœä¼ ç»Ÿçš„å®šä½ã€å¤ç°é—®é‡åˆ°å›°éš¾ï¼Œä¸å¦¨è€ƒè™‘éƒ¨ç½²Debugç‰ˆåˆ°çº¿ä¸Šç¯å¢ƒï¼Œè·å–æ›´å¤šä¿¡æ¯ã€‚\n","wordCount":"2208","inLanguage":"en","datePublished":"2023-06-13T00:00:00Z","dateModified":"2023-06-13T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://pps43.github.io/posts/using_physx_solving_zero_value_crash/"},"publisher":{"@type":"Organization","name":"æ³¢æ³¢æ²™ğŸ ","logo":{"@type":"ImageObject","url":"https://pps43.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://pps43.github.io accesskey=h title="æ³¢æ³¢æ²™ğŸ  (Alt + H)">æ³¢æ³¢æ²™ğŸ </a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://pps43.github.io/archives title=Archive><span>Archive</span></a></li><li><a href=https://pps43.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://pps43.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://book.enginew.cn/ title=BookOfGameDev><span>BookOfGameDev</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>PhysXé›¶å€¼Crash</h1><div class=post-meta><span title='2023-06-13 00:00:00 +0000 UTC'>June 13, 2023</span>&nbsp;Â·&nbsp;5 min</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%8f%91%e7%8e%b0%e9%97%ae%e9%a2%98 aria-label=å‘ç°é—®é¢˜>å‘ç°é—®é¢˜</a></li><li><a href=#%e7%ac%ac%e4%b8%80%e6%ac%a1%e5%b0%9d%e8%af%95%e4%bf%ae%e5%a4%8d aria-label=ç¬¬ä¸€æ¬¡å°è¯•ä¿®å¤>ç¬¬ä¸€æ¬¡å°è¯•ä¿®å¤</a></li><li><a href=#%e7%ac%ac%e4%ba%8c%e6%ac%a1%e5%b0%9d%e8%af%95%e4%bf%ae%e5%a4%8d aria-label=ç¬¬äºŒæ¬¡å°è¯•ä¿®å¤>ç¬¬äºŒæ¬¡å°è¯•ä¿®å¤</a></li><li><a href=#%e6%80%bb%e7%bb%93 aria-label=æ€»ç»“>æ€»ç»“</a></li></ul></div></details></div><div class=post-content><blockquote><p>æœ¬æ–‡æ˜¯<a href=https://pps43.github.io/tags/physx/>PhysXç‰©ç†å¼•æ“ç³»åˆ—</a>çš„ç‰¹åˆ«ç¯‡ï¼Œè®°å½•äº†å½±å“è¿‘ä¸€å‘¨çš„ç‰©ç†å¼•æ“åº•å±‚æ¦‚ç‡æ€§Crashçš„å®šä½è¿‡ç¨‹å’Œä¿®å¤æ–¹æ³•ï¼Œå…·æœ‰<strong>å¾ˆé«˜</strong>çš„å®è·µå‚è€ƒä»·å€¼ã€‚<em>â€œæœ‰å¤šé«˜ï¼Ÿâ€â€œä¸‰å››å±‚æ¥¼é‚£ä¹ˆé«˜å•¦ï¼â€</em></p></blockquote><h1 id=å‘ç°é—®é¢˜>å‘ç°é—®é¢˜<a hidden class=anchor aria-hidden=true href=#å‘ç°é—®é¢˜>#</a></h1><p>è¿ç»´åŒäº‹å‘ç°ä½“éªŒæœå’ŒæŸåŒºåœ¨æ–°ç‰ˆæœ¬ä¸Šçº¿ä¸€å°æ®µæ—¶é—´åï¼Œä¼šå‡ºç°æ¦‚ç‡ä¸é«˜ä½†æŒç»­å‡ºç°çš„è¿›ç¨‹Crashã€‚è¿™é‡Œå…ˆç®€å•è¯´æ˜ä¸€ä¸‹ï¼šæˆ‘ä»¬ä¼šåœ¨ä¸€å°æœºå™¨ä¸Šéƒ¨ç½²å¤šä¸ªGameServerå®ä¾‹ï¼Œæ¯ä¸ªGameServerå®ä¾‹è¿›ç¨‹åŒæ—¶è¿›è¡Œç€å¤šåœºä¸åŒçš„Matchï¼Œå¦‚æœæŸä¸€åœºMatchå‡ºç°äº†ä¸šåŠ¡å±‚Crashï¼Œå¹¶ä¸ä¼šå½±å“å…¶ä»–Matchã€‚ä½†å¦‚æœæ˜¯C++ç‰©ç†åº“å†…å‡ºç°Crashï¼Œåˆ™ä¼šåŒæ—¶ä¸­æ­¢å…¶ä»–æ­£å¸¸è¿è¡Œçš„Matchï¼Œå¯¹ç©å®¶çš„å½±å“è¾ƒå¤§ã€‚</p><p>è™½ç„¶çœ‹ä¸åˆ°å®Œæ•´çš„å †æ ˆï¼Œä½†ä»ä¸­è¿˜æ˜¯å‘ç°å’Œç‰©ç†å¼•æ“çš„<code>SceneQuery</code>æœ‰å…³ã€‚
<img loading=lazy src=/using_physx_solving_zero_value_crash/crash_log.png alt></p><p>å…¶å®è¿˜æœ‰å¦ä¸€ä¸ªå¾ˆç›¸ä¼¼çš„å †æ ˆï¼ˆå¿˜è®°ä¿å­˜æˆªå›¾äº†ï¼‰åœ¨<code>prefilter</code>ä¸Šæ–¹è¿˜æœ‰ä¸€è¡Œ<code>NpShape vtable...</code>ã€‚ç”±äº<code>prefilter</code>å®ç°é€»è¾‘ä¸­ç¡®å®è°ƒç”¨äº†<code>shape.getFlags()</code>ï¼Œæ‰€ä»¥æ€€ç–‘æ˜¯è·Ÿ<code>shape</code>ç›¸å…³é€»è¾‘ä¸­å‡ºç°ç©ºæŒ‡é’ˆå¼•ç”¨ã€‚ä½†ç”±äºshapeæ˜¯å¼•æ“å†…éƒ¨ç»´æŠ¤çš„ï¼Œæ‰€ä»¥ä¸Šè¿°æ€€ç–‘å¹¶ä¸èƒ½æä¾›æ˜ç¡®çš„ä¿®å¤æ–¹æ³•ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// prefilter implementaion
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>PxQueryHitType</span><span class=o>::</span><span class=n>Enum</span> <span class=n>PhysxQueryFilterCallback</span><span class=o>::</span><span class=n>preFilter</span><span class=p>(</span><span class=k>const</span> <span class=n>PxFilterData</span><span class=o>&amp;</span> <span class=n>filterData</span><span class=p>,</span> <span class=k>const</span> <span class=n>PxShape</span><span class=o>*</span> <span class=n>shape</span><span class=p>,</span> <span class=k>const</span> <span class=n>PxRigidActor</span><span class=o>*</span> <span class=n>actor</span><span class=p>,</span> <span class=n>PxHitFlags</span><span class=o>&amp;</span> <span class=n>queryFlags</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>bool</span> <span class=n>isTrigger</span> <span class=o>=</span> <span class=n>shape</span><span class=o>-&gt;</span><span class=n>getFlags</span><span class=p>()</span> <span class=o>&amp;</span> <span class=n>physx</span><span class=o>::</span><span class=n>PxShapeFlag</span><span class=o>::</span><span class=n>eTRIGGER_SHAPE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>isTrigger</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>m_IncludeTrigger</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>PxQueryHitType</span><span class=o>::</span><span class=n>eNONE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>PxFilterData</span> <span class=n>shapefilterData</span> <span class=o>=</span> <span class=n>shape</span><span class=o>-&gt;</span><span class=n>getQueryFilterData</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>shapefilterData</span><span class=p>.</span><span class=n>word0</span> <span class=o>&amp;</span> <span class=n>filterData</span><span class=p>.</span><span class=n>word0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// m_HitType should be PxQueryHitType::eBLOCK or PxQueryHitType::eTOUCH
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>return</span> <span class=n>m_HitType</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>PxQueryHitType</span><span class=o>::</span><span class=n>eNONE</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// shape-&gt;getFlags() implementation (fron physx source code)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>PxShapeFlags</span> <span class=n>NpShape</span><span class=o>::</span><span class=n>getFlags</span><span class=p>()</span> <span class=k>const</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>NP_READ_CHECK</span><span class=p>(</span><span class=n>getOwnerScene</span><span class=p>());</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>mShape</span><span class=p>.</span><span class=n>getFlags</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>ç”±äºåŒæœŸå‘å¸ƒçš„è¿˜æœ‰å…¶ä»–ç‰©ç†ç›¸å…³åŠŸèƒ½ï¼Œå…ˆé€šè¿‡å¼€å…³è¿™äº›åŠŸèƒ½æ¥å¯¹Crashåšåˆæ­¥åˆ¤å®šã€‚æœ‰ä¸€ä¸ªå»¶è¿Ÿåˆ é™¤Actorçš„ä¼˜åŒ–è¾ƒä¸ºå¯ç–‘ï¼Œå…³é—­è¯¥åŠŸèƒ½åï¼ŒCrashç¡®å®å‡å°‘äº†ä¸€å°éƒ¨åˆ†ã€‚</p><p>å¦å¤–ä¹Ÿå°è¯•é€šè¿‡åˆ†ææ—¥å¿—å¯¹è¿™äº›Crashå‘ç”Ÿçš„æƒ…å¢ƒåšçŒœæµ‹ï¼Œä¾¿äºå¤ç°ã€‚å‰é¢æåˆ°è¿‡ï¼Œç‰©ç†å±‚ä¸€æ—¦Crashä¼šå½±å“åˆ°è¯¥è¿›ç¨‹ä¸‹å…¶ä»–æ­£å¸¸è¿›è¡Œçš„æ¯”èµ›ã€‚æ‰€ä»¥åªå¥½æŠ“å–äº†Crashå‘ç”Ÿå‰200msçš„æ‰€æœ‰ç›¸å…³æ¯”èµ›çš„æ—¥å¿—ï¼Œå¤§è‡´èƒ½çœ‹å‡ºæœ€åå‡ ç§’å†…ç©å®¶è¿›è¡Œäº†å“ªäº›æ“ä½œï¼šå•†åº—è´­ä¹°ã€åˆ‡æ¢æ­¦å™¨ã€ä¼¤å®³æ‰£è¡€ã€æ‰”æ‰‹é›·ã€‚è¿™é‡Œåªæœ‰æ‰”æ‰‹é›·å’Œç‰©ç†å±‚æœ‰å…³è”ï¼Œè¿›ä¸€æ­¥æ‰¾åˆ°è¯¥åœºæ¯”èµ›çš„æ¨¡å¼ä¿¡æ¯ï¼Œå‘Šè¯‰QAåŒå­¦å°è¯•å¤ç°ã€‚</p><h1 id=ç¬¬ä¸€æ¬¡å°è¯•ä¿®å¤>ç¬¬ä¸€æ¬¡å°è¯•ä¿®å¤<a hidden class=anchor aria-hidden=true href=#ç¬¬ä¸€æ¬¡å°è¯•ä¿®å¤>#</a></h1><p>æµ‹è¯•ç¯å¢ƒä¸­ä¸€ç›´æœªèƒ½å¤ç°ï¼Œæ‰€ä»¥å…ˆå°è¯•äº†ä¸€äº›é˜²å¾¡æ€§åˆ¤ç©ºä¿®å¤ã€‚æ¯”å¦‚åœ¨æ¯å¸§é©±åŠ¨ç‰©ç†æ›´æ–°æ—¶ï¼Œå¯¹Sceneçš„åˆ¤ç©ºï¼›åˆæ¯”å¦‚åœ¨<code>OnContact</code>æ—¶ï¼Œå¢åŠ äº†å¯¹<code>actor</code>å’Œ<code>shape</code>å¤±æ•ˆçŠ¶æ€çš„åˆ¤æ–­ï¼Œå¹¶ä¸”è·å–<code>actor</code>çš„æ–¹å¼ç”±<code>pairs[i].shapes[0]->getActor()</code>æ”¹ä¸º<code>pairHeader.actors[0]</code>ã€‚è¿™äº›ä¿®å¤ç¡®å®èƒ½åŠ å¼ºç¨‹åºçš„å¥å£®æ€§ï¼Œä½†å¯æƒœå¯¹æœ¬æ¬¡çš„Crashå¹¶æ²¡æœ‰ç›´æ¥å¸®åŠ©ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>void</span> <span class=n>PhysxSimulationEventCallback</span><span class=o>::</span><span class=n>onContact</span><span class=p>(</span><span class=k>const</span> <span class=n>PxContactPairHeader</span><span class=o>&amp;</span> <span class=n>pairHeader</span><span class=p>,</span> <span class=k>const</span> <span class=n>PxContactPair</span><span class=o>*</span> <span class=n>pairs</span><span class=p>,</span> <span class=n>PxU32</span> <span class=n>nbPairs</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// add actor validation
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=p>(</span><span class=n>pairHeader</span><span class=p>.</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>PxContactPairHeaderFlag</span><span class=o>::</span><span class=n>eREMOVED_ACTOR_0</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>		<span class=n>pairHeader</span><span class=p>.</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>PxContactPairHeaderFlag</span><span class=o>::</span><span class=n>eREMOVED_ACTOR_1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=n>PxRigidActor</span><span class=o>*</span> <span class=n>actorA</span> <span class=o>=</span> <span class=p>(</span><span class=n>PxRigidActor</span><span class=o>*</span><span class=p>)</span><span class=n>pairHeader</span><span class=p>.</span><span class=n>actors</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=n>PxRigidActor</span><span class=o>*</span> <span class=n>actorB</span> <span class=o>=</span> <span class=p>(</span><span class=n>PxRigidActor</span><span class=o>*</span><span class=p>)</span><span class=n>pairHeader</span><span class=p>.</span><span class=n>actors</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(</span><span class=n>PxU32</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>nbPairs</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>const</span> <span class=n>PxContactPair</span><span class=o>&amp;</span> <span class=n>curPair</span> <span class=o>=</span> <span class=n>pairs</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// add shape validation
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=p>(</span><span class=n>curPair</span><span class=p>.</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>PxContactPairFlag</span><span class=o>::</span><span class=n>eREMOVED_SHAPE_0</span> <span class=o>|</span> <span class=n>PxContactPairFlag</span><span class=o>::</span><span class=n>eREMOVED_SHAPE_1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>curPair</span><span class=p>.</span><span class=n>events</span> <span class=o>&amp;</span> <span class=n>PxPairFlag</span><span class=o>::</span><span class=n>eNOTIFY_TOUCH_PERSISTS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// do nothing when contact persists
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>PhysXContactResult</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>result</span><span class=p>.</span><span class=n>Lost</span> <span class=o>=</span> <span class=n>curPair</span><span class=p>.</span><span class=n>events</span> <span class=o>&amp;</span> <span class=n>PxPairFlag</span><span class=o>::</span><span class=n>eNOTIFY_TOUCH_LOST</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>result</span><span class=p>.</span><span class=n>ColliderA</span> <span class=o>=</span> <span class=n>actorA</span> <span class=o>==</span> <span class=nb>NULL</span> <span class=o>?</span> <span class=nb>NULL</span> <span class=o>:</span> <span class=p>(</span><span class=n>PhysXActor</span><span class=o>*</span><span class=p>)</span> <span class=n>actorA</span><span class=o>-&gt;</span><span class=n>userData</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>result</span><span class=p>.</span><span class=n>ColliderB</span> <span class=o>=</span> <span class=n>actorB</span> <span class=o>==</span> <span class=nb>NULL</span> <span class=o>?</span> <span class=nb>NULL</span> <span class=o>:</span> <span class=p>(</span><span class=n>PhysXActor</span><span class=o>*</span><span class=p>)</span> <span class=n>actorB</span><span class=o>-&gt;</span><span class=n>userData</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>result</span><span class=p>.</span><span class=n>ColliderA</span> <span class=o>!=</span> <span class=nb>NULL</span> <span class=o>&amp;&amp;</span> <span class=n>result</span><span class=p>.</span><span class=n>ColliderB</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>m_ContactRecords</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>result</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h1 id=ç¬¬äºŒæ¬¡å°è¯•ä¿®å¤>ç¬¬äºŒæ¬¡å°è¯•ä¿®å¤<a hidden class=anchor aria-hidden=true href=#ç¬¬äºŒæ¬¡å°è¯•ä¿®å¤>#</a></h1><p>ä¸ºäº†è·å–æ›´å¤šä¿¡æ¯ï¼Œå†³å®šè´¹ä¸€äº›å‘¨ç« ï¼Œåœ¨ä¸€å°çº¿ä¸Šæœºå™¨éƒ¨ç½²Debugç‰ˆç‰©ç†åº“ã€‚äº‹å®è¯æ˜ï¼Œè¿™ä¸ªåŠªåŠ›æ˜¯å€¼å¾—çš„ã€ç«‹ç«¿è§å½±çš„ã€‚</p><p>å¹³æ—¶æœåŠ¡å™¨ç¨‹åºæ‰“ReleaseåŒ…æ—¶ï¼Œé“¾æ¥åˆ°Releaseç‰ˆçš„ç‰©ç†åº“å·¥ç¨‹ï¼ˆåº•å±‚ä½¿ç”¨äº†<code>physX</code>ï¼‰ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>physxgo</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>#cgo CPPFLAGS: -Wno-attributes -I ./include -O3 -DNDEBUG
</span></span></span><span class=line><span class=cl><span class=cm>#cgo LDFLAGS:-L ./lib -lPhysXWrapper_x64 -O3
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=err>&#34;</span><span class=nx>C</span>
</span></span></code></pre></div><p>ç°æ”¹ä¸ºé“¾æ¥åˆ°Debugç‰ˆç‰©ç†åº“å·¥ç¨‹ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>physxgo</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>#cgo CPPFLAGS: -Wno-attributes -I ./include -O1 -DNDEBUG
</span></span></span><span class=line><span class=cl><span class=cm>#cgo LDFLAGS:-L ./lib -lPhysXWrapperDEBUG_x64 -O1
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;C&#34;</span>
</span></span></code></pre></div><p>åœ¨æœ¬åœ°Windowsä¸Šæµ‹è¯•é€šè¿‡åï¼Œéƒ¨ç½²åˆ°Linuxå´å¤±è´¥äº†ï¼šå‘ç°ä¾ç„¶é“¾æ¥åˆ°Releaseç‰©ç†åº“ã€‚</p><blockquote><p>è¿™é‡Œç¨åŠ è¯´æ˜ï¼šæœåŠ¡å™¨æ˜¯Linuxçš„ï¼Œä½†ä¸ºäº†å¹³æ—¶èƒ½åœ¨Windowsä¸Šå¼€å‘è°ƒè¯•ç‰©ç†åº“ï¼Œæˆ‘ä»¬æ­å»ºäº†ä¸¤å¥—æ„å»ºæµç¨‹ã€‚åœ¨Linuxä¸Šä½¿ç”¨makefileç¼–è¯‘å‡º<code>.so</code>ï¼Œåœ¨Windowsä¸Šæ„å»ºå‡º<code>.dll</code>ä¾›<code>cgo</code>è°ƒç”¨ã€‚æ³¨æ„<code>cgo</code>ä½¿ç”¨<code>gcc</code>ï¼Œç”±äºname manglingæ–¹å¼å’Œ<code>MSVC</code>ä¸åŒï¼Œåœ¨ä½¿ç”¨<code>MSVC</code>ç¼–è¯‘æ—¶éœ€è¦åœ¨<code>.def</code>æ–‡ä»¶ä¸­æŒ‡å®šæ¯ä¸ªå¯¼å‡ºçš„å‡½æ•°ç¼–è¯‘åçš„åå­—ï¼Œå½¢å¦‚<code>x=y</code>ï¼Œè¿™æ ·<code>MSVC</code>ä¼šæŠŠè‡ªå·±ç¼–å‡ºçš„<code>y</code>ç¿»è¯‘æˆ<code>x</code>ï¼Œä»¥ä¾¿å’Œ<code>gcc</code>å…¼å®¹ã€‚</p><p>ä¸¾ä¾‹ï¼š<code>_ZN10PhysXActor11SetPositionEfff=?SetPosition@PhysXActor@@QEAAXMMM@Z</code></p></blockquote><p>åŸå› æ˜¯<code>go build</code>æ˜¯å¼ºåˆ¶ä½¿ç”¨äº†é…ç½®çš„ç¯å¢ƒå˜é‡ä»¥åŠç¼“å­˜ã€‚ä½¿ç”¨<code>go build -d</code>æ¸…ç©ºç¼“å­˜å³å¯ã€‚</p><p>æˆåŠŸéƒ¨ç½²DebugåŒ…åˆ°ä¸€å°æœåŠ¡å™¨ä¸Šåï¼Œè¿‡15minå°±Crashäº†ï¼Œåœ¨æœ€åä¸€åˆ»ä¼ é€’å‡ºäº†æ–°çš„ä¿¡æ¯ï¼š</p><p><img loading=lazy src=/using_physx_solving_zero_value_crash/crash_log_2.png alt></p><p>åˆ›å»ºshapeæ—¶å‚æ•°ä¸åˆæ³•ï¼Œé¦–å…ˆæ€€ç–‘ä¼ å…¥äº†0æˆ–NaNã€‚è¿›ä¸€æ­¥çš„æ’æŸ¥å‘ç°ï¼Œè¿™ä¸ªç‰ˆæœ¬ä½¿ç”¨äº†æ–°ç‰ˆçš„åˆ›å»ºå‡½æ•°ï¼Œç¡®å®ç›¸æ¯”è€çš„åˆ›å»ºæµç¨‹å°‘äº†ä¸€ä¸ªå‚æ•°åˆæ³•æ€§æ ¡éªŒã€‚å½“å‘ç°æŸä¸ªç»´åº¦å‡ºç°0å€¼æ—¶ï¼Œè™½ç„¶ä¸ä¼šç«‹å³Crashï¼Œä½†åœ¨åç»­è¢«Raycastç­‰æ“ä½œè®¿é—®åˆ°æ—¶ï¼Œä¼šæ¦‚ç‡æ€§Crashã€‚è§£å†³æ–¹æ³•å¾ˆç®€å•ï¼Œåœ¨ä¸šåŠ¡å±‚å·²æœ‰ä»£ç ä¸­ï¼Œå‘ç°ä¼ å…¥0æ—¶ç»™å‡ºè­¦å‘Šå¹¶returnï¼›åœ¨åº•å±‚ä»£ç ä¸­åˆ›å»ºshapeæ—¶ï¼Œå¼ºåˆ¶å°†å€¼ä¸º0çš„ç»´åº¦æ”¹ä¸ºä¸€ä¸ªå¾®å°çš„å€¼ï¼Œå¦‚ä¸‹<code>ForceNonZero</code>ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>void</span> <span class=nf>ForceNonZero</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>//EPS = 1.192092896e-07F (machine epsilon for float)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=p>(</span><span class=n>physx</span><span class=o>::</span><span class=n>PxAbs</span><span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>EPS</span><span class=p>)</span> <span class=p>{</span> <span class=n>x</span> <span class=o>=</span> <span class=n>x</span> <span class=o>&gt;=</span> <span class=mi>0</span> <span class=o>?</span> <span class=nl>EPS</span> <span class=p>:</span> <span class=o>-</span><span class=n>EPS</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>physx</span><span class=o>::</span><span class=n>PxAbs</span><span class=p>(</span><span class=n>y</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>EPS</span><span class=p>)</span> <span class=p>{</span> <span class=n>y</span> <span class=o>=</span> <span class=n>y</span> <span class=o>&gt;=</span> <span class=mi>0</span> <span class=o>?</span> <span class=nl>EPS</span> <span class=p>:</span> <span class=o>-</span><span class=n>EPS</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>physx</span><span class=o>::</span><span class=n>PxAbs</span><span class=p>(</span><span class=n>z</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>EPS</span><span class=p>)</span> <span class=p>{</span> <span class=n>z</span> <span class=o>=</span> <span class=n>z</span> <span class=o>&gt;=</span> <span class=mi>0</span> <span class=o>?</span> <span class=nl>EPS</span> <span class=p>:</span> <span class=o>-</span><span class=n>EPS</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>éƒ¨ç½²è¯¥ä¿®å¤åï¼ŒCrashå½’é›¶ã€‚</p><p><img loading=lazy src=/using_physx_solving_zero_value_crash/crash_over.png alt></p><p>å¹¶ä¸”é€šè¿‡Debugç‰ˆç»™å‡ºçš„è­¦å‘Šï¼Œæˆ‘ä»¬è¿˜å¯¹æ•°å€¼ç±»å‚æ•°åšäº†NaNæˆ–Infæ ¡éªŒ<code>physx::PxIsFinite</code>ï¼Œå¹¶ä¸”å¯¹æ–¹å‘ç±»å‚æ•°åšäº†å¼ºåˆ¶å½’ä¸€åŒ–ï¼Œè¿›ä¸€æ­¥æé«˜äº†ç‰©ç†ç³»ç»Ÿç¨³å®šæ€§ã€‚å€¼æ­¤ï¼Œä¿®å¤å®Œæˆã€‚</p><h1 id=æ€»ç»“>æ€»ç»“<a hidden class=anchor aria-hidden=true href=#æ€»ç»“>#</a></h1><ul><li><p>å¯¹äºä¼ å…¥<code>physX</code>çš„å‚æ•°å¿…é¡»ä¸¥æ ¼ä¿è¯æœ‰æ•ˆæ€§ã€‚</p><ul><li>åŸºæœ¬è¦æ±‚ï¼šæ•°å€¼ç±»ä¸å¯ä»¥æ˜¯NaN, Inf</li><li>å°ºå¯¸ç±»ä¸å¯ä»¥æ˜¯0</li><li>æ–¹å‘ç±»çŸ¢é‡å¿…é¡»æ¨¡é•¿ä¸º1</li></ul></li><li><p>å¹³æ—¶å¼€å‘ä¸­å¤šå…³æ³¨Debugç‰ˆçš„è¾“å‡ºï¼Œå¯¹äºè­¦å‘Šå’Œé”™è¯¯éƒ½è¦é«˜åº¦é‡è§†ã€‚</p></li><li><p>é—®é¢˜å‘ç”Ÿæ—¶ï¼Œå¦‚æœä¼ ç»Ÿçš„å®šä½ã€å¤ç°é—®é‡åˆ°å›°éš¾ï¼Œä¸å¦¨è€ƒè™‘éƒ¨ç½²Debugç‰ˆåˆ°çº¿ä¸Šç¯å¢ƒï¼Œè·å–æ›´å¤šä¿¡æ¯ã€‚</p></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://pps43.github.io/tags/game-dev/>Game Dev</a></li><li><a href=https://pps43.github.io/tags/physx/>PhysX</a></li></ul><nav class=paginav><a class=prev href=https://pps43.github.io/posts/notes_on_genius_in_ghibli/><span class=title>Â« Prev</span><br><span>å‰åœåŠ›çš„å¤©æ‰ä»¬ï¼ˆé“ƒæœ¨æ•å¤«ï¼‰</span></a>
<a class=next href=https://pps43.github.io/posts/notes_on_why_buddhism_is_true/><span class=title>Next Â»</span><br><span>æ´è§Â·ä¸ºä»€ä¹ˆä½›å­¦æ˜¯çœŸçš„</span></a></nav></footer></article></main><footer class=footer><span>Â© 2016-2023 By æ³¢æ³¢æ²™.</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>